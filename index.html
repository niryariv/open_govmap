<!DOCTYPE html>
<html style='width:100%; height:100%;'>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=7,IE=9" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>


   @import url(https://fonts.googleapis.com/earlyaccess/alefhebrew.css);
.navbar-brand {
  transform: translateX(-50%);
  left: 50%;
  position: absolute;
}


.navbar-brand {
  transform: translateX(-50%);
  left: 50%;
  position: absolute;
}

@media (max-width: 600px) {
    #myTitle {
      display: none;
    }
	#myTitleMobile {
      display: inline-flex;
    }
  }

   @media (min-width: 600px) {
    #myTitleMobile {
      display: none;
    }
	#myTitle {
      display: inline-flex;
    }
  }

  #myTitle{
		font-family: "Alef Hebrew",
               “Helvetica Neue”,
               Helvetica,
               Arial,
               sans-serif;
	}
	#myTitleMobile{
			font-family: "Alef Hebrew",
				   “Helvetica Neue”,
				   Helvetica,
				   Arial,
				   sans-serif;
	}

	#tab_logic{
	font-family: "Alef Hebrew",
               “Helvetica Neue”,
               Helvetica,
               Arial,
               sans-serif;
	}

	#OptionsButton{
	font-family: "Alef Hebrew",
               “Helvetica Neue”,
               Helvetica,
               Arial,
               sans-serif;
	}

	#myModalstring{
	font-family: "Alef Hebrew",
               “Helvetica Neue”,
               Helvetica,
               Arial,
               sans-serif;
	}

	#string_address{
	font-family: "Alef Hebrew",
               “Helvetica Neue”,
               Helvetica,
               Arial,
               sans-serif;
	}

	#searchButton{
	font-family: "Alef Hebrew",
               “Helvetica Neue”,
               Helvetica,
               Arial,
               sans-serif;
	}

	#cbx_types{
	font-family: "Alef Hebrew",
               “Helvetica Neue”,
               Helvetica,
               Arial,
               sans-serif;
	}


.modal.left .modal-dialog,
	.modal.right .modal-dialog {
		position: fixed;
		margin: auto;
		width: 250px;
		height: 100%;
		-webkit-transform: translate3d(0%, 0, 0);
		    -ms-transform: translate3d(0%, 0, 0);
		     -o-transform: translate3d(0%, 0, 0);
		        transform: translate3d(0%, 0, 0);
	}

	.modal.left .modal-content,
	.modal.right .modal-content {
		height: 100%;
		overflow-y: auto;
	}

	.modal.left .modal-body,
	.modal.right .modal-body {
		padding: 15px 15px 80px;
	}

/*Left*/
	.modal.left.fade .modal-dialog{
		left: -250px;
		-webkit-transition: opacity 0.3s linear, left 0.3s ease-out;
		   -moz-transition: opacity 0.3s linear, left 0.3s ease-out;
		     -o-transition: opacity 0.3s linear, left 0.3s ease-out;
		        transition: opacity 0.3s linear, left 0.3s ease-out;
	}

	.modal.left.fade.in .modal-dialog{
		left: 0;
	}


/* ----- MODAL STYLE ----- */
	.modal-content {
		border-radius: 0;
		border: none;
	}

	.modal-header {
		border-bottom-color: #EEEEEE;
		background-color: #FAFAFA;
	}
  </style>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script language="javascript" type="text/javascript" src="https://www.govmap.gov.il/govmap/api/govmap.api.js" ></script>

  <script>


		var my_token = "5a4b8472-b95b-4687-8179-0ccb621c7990"; //for localhost domain
		//var my_user_token = "ca2048da-bece-44d6-8576-ea35ddfa2f76";
		var o;
		var func_type = "";
		var res_v;
		var fields;
		 $(document).ready(function ()
        {
	            govmap.createMap('map_div',
	                {
                    token: my_token,
					//user_token: "ca2048da-bece-44d6-8576-ea35ddfa2f76",
                    //visibleLayers: ["KALPI_NEGISHUT", "GASSTATIONS", "DIVUCHIM2017"],
					visibleLayers: ["NEIGHBORHOODS_AREA"],
					layers: ["NEIGHBORHOODS_AREA"],
					layersMode: 2,
					//isEmbeddedToggle: false,
					showXY: true,
					center: {x: 217009, y: 708689},// {x: 180996, y: 663402},
					level: 5,
                    identifyOnClick: true
					});

		});
	 var circle_result;
	 var circleInfo;
	 var click_result;
	var parcel_result;
	var e_obj;
	 $(function(){

		$("#cbx_types li a").click(function(){

		  $(".btn:first-child").text($(this).text());
		  	func_type = $(this).text();
			var address = "";
		  	if (func_type == "AddUserPoint1")
			{
				//govmap.draw(govmap.drawType.Point).progress(function (e)
				//{
						var data = {
							'wkts': ['POINT(196062.48 621458.39)',
									 'POINT(200000.48 600000.39)',
									 'POINT(250000.48 650000.39)'
							],

							'names': ['p1',
									  'p2',
									  'p3'],
							'geometryType': govmap.drawType.Point,
							'defaultSymbol':
							{
								'url':'http://maps.google.com/mapfiles/ms/micons/horsebackriding.png',
								'width':15,
								'height':15
							},

							'symbols': [{
								'url':'http://maps.google.com/mapfiles/ms/micons/horsebackriding.png',
								'width':15,
								'height':15
								},
								{
								'url':'http://maps.google.com/mapfiles/ms/micons/horsebackriding.png',
								'width':15,
								'height':15
								},
								{
								'url':'http://maps.google.com/mapfiles/ms/micons/horsebackriding.png',
								'width':15,
								'height':15
								}
							],
							'clearExisting': false,
							'data': {
							'tooltips': ['tooltip1', 'tooltip2','tooltip3'],
							'bubbles': ['', '',''],
							'bubbleUrl': 'https://ynet.co.il'
							}
						};
						govmap.displayGeometries(data).then(function (e)
						{
							console.log(e.data);
						});
				//});


			}

			if (func_type == "GeocodeString")
			{
				$("#myModal").modal("show");
			}
			if (func_type == "GetSearchAccuracy")
			{
				GovMapGisApi_GetSearchAccuracy(address, "GetSearchAccuracyResult");
			}
			if (func_type == "GetXY")
			{
				govmap.getXY().progress(function (e)
				{
					console.log(e);
					//alert(e.mapPoint.x + " / " + e.mapPoint.y);
					govmap.setDefaultTool();
				});
			}
			if (func_type == "DrawRectangle")
			{
				govmap.draw(govmap.drawType.Rectangle).progress(function (e)
				{
						wkt = e.wkt;
						console.log(wkt);
						var thep = document.getElementById("info");
						thep.innerHTML = "";
						thep.appendChild(document.createElement("br"));
						thep.appendChild(document.createTextNode("WKT:"));
						thep.appendChild(document.createElement("br"));
						thep.appendChild(document.createTextNode(wkt));
						thep.appendChild(document.createElement("br"));
						thep.className="lead";
						document.getElementById("myModalLabel").innerHTML = "Rectangle Info";
						$("#myInfoModal").modal("show");
				});

			}
			if (func_type == "DrawCircle")
			{
				govmap.draw(govmap.drawType.Circle).progress(function (e)
				{
					circleInfo = e;
					var thep = document.getElementById("info");
					thep.innerHTML = "";
					thep.appendChild(document.createElement("br"));
					thep.appendChild(document.createTextNode("X Coordinate:"));
					thep.appendChild(document.createElement("br"));
					thep.appendChild(document.createTextNode(e.x));
					thep.appendChild(document.createElement("br"));
					thep.appendChild(document.createElement("br"));
					thep.appendChild(document.createElement("br"));
					thep.appendChild(document.createTextNode("Y Coordinate:"));
					thep.appendChild(document.createElement("br"));
					thep.appendChild(document.createTextNode(e.y));
					thep.appendChild(document.createElement("br"));
					thep.appendChild(document.createElement("br"));
					thep.appendChild(document.createElement("br"));
					thep.appendChild(document.createTextNode("Radius:"));
					thep.appendChild(document.createElement("br"));
					thep.appendChild(document.createTextNode(e.radius));
					document.getElementById("myModalLabel").innerHTML = "Circle Info";
					thep.className="lead";
					$("#myInfoModal").modal("show");
				});
			}

			if (func_type == "DrawPolygon")
			{
				govmap.draw(govmap.drawType.Polygon).progress(function (e)
				{
					console.log(e.wkt);
					govmap.intersectFeatures({
					geometry: e.wkt,
					layerName: "TAZNATIONALMOTRATE2040_MOT",
					fields: ['OBJECTID','MOTORATE40']
					}).then(function (e)
					{
						result = e;
						console.log(e.data[0].Values[0]);
					});

					var thep = document.getElementById("info");
					thep.innerHTML = "";
					thep.appendChild(document.createElement("WKT:"));
					thep.appendChild(document.createElement("br"));
					thep.appendChild(document.createTextNode(e.wkt));
					document.getElementById("myModalLabel").innerHTML = "WKT Info";
					thep.className="lead";
					$("#myInfoModal").modal("show");
					});
			}
			if (func_type == "AddUserPoint")
			{


				var bubbleContent = "<div style='border: 1px solid #525252; margin: 10px;padding: 10px;'><div style='background-color: yellow;'>{0}</div><div               style='background-color: blue;'>{1}</div></div>";
				var data = {
					wkts: ["POLYGON((151612.40 534674.88, 215112.52 538643.64, 98431.04 445774.70, 74618.49 521974.85, 80968.50 552931.17, 151612.40 533881.13,151612.40 534674.88))",
							"POLYGON((196062.48 621458.39, 196591.65 622516.72, 197649.99 659293.88, 229929.22 665379.31, 243423.00 632306.33, 196062.48 621458.39))"],
					names: ['p1', 'p2'],
					geometryType: govmap.drawType.Polygon,
					defaultSymbol:
						{
						outlineColor: [0, 80, 255, 1],
						outlineWidth: 1,
						fillColor: [138, 43, 226, 0.5]
						},
					symbols: [],
					clearExisting: true,
					data: {
							tooltips: ['פוליגון 1 tooltip', 'פוליגון 2 tooltip'],
							headers: ['פוליגון 1 כותרת','פוליגון 2 כותרת'],
							bubbleHTML: bubbleContent,
							bubbleHTMLParameters: [['פוליגון 1','מידע נוסף...'], ['פוליגון 2', 'מידע נוסף...']]
					}
                };

				govmap.displayGeometries(data).then(function (response)
				{
				  console.log(response.data);
				});

			}
			if (func_type == "ZoomToDrawing")
			{
				govmap.zoomToDrawing();
			}
			if (func_type == "ClearDrawing")
			{
				govmap.clearDrawings();
			}
			if (func_type == "FilterLayer")
			{
				//govmap.filterLayers({ 'layerName': "PARCEL_ALL", 'whereClause': "GUSH_NUM =7620 AND PARCEL =274", 'zoomToExtent': true });
				govmap.filterLayers({ 'layerName': "NEIGHBORHOODS_AREA", 'whereClause': "FNAME ='נווה סביון'", 'zoomToExtent': true });
			}
			if (func_type == "searchInLayer1")
			{
				//govmap.searchInLayer({ 'layerName': 'PARCEL_ALL', 'fieldName': 'GUSH_NUM', 'fieldValues': [7620], 'highlight': true });
				//govmap.searchInLayer({ 'layerName': 'ECONOMYLOTS', 'fieldName': 'LOTIDSTRING', 'fieldValues': ['C5H0000', 'C5GB000', 'C5D0000'], 'highlight': true });

				//govmap.searchInLayer({ 'layerName': 'ECONOMYLOTS_MOCH', 'fieldName': 'LOTIDINT', 'fieldValues': [7334, 8920], 'highlight': true, 'showBubble': true });


			}
			if (func_type == "searchInLayer2")
			{
				//govmap.searchInLayer({ 'layerName': 'PARCEL_ALL', 'fieldName': 'GUSH_NUM', 'fieldValues': [7620], 'highlight': true });
				//govmap.searchInLayer({ 'layerName': 'ECONOMYLOTS', 'fieldName': 'LOTIDSTRING', 'fieldValues': ['C5H0000', 'C5GB000', 'C5D0000'], 'highlight': true });

				//govmap.searchInLayer({ 'layerName': 'ECONOMYLOTS_MOCH', 'fieldName': 'LOTIDINT', 'fieldValues': [7334, 8920], 'highlight': true, 'showBubble': true });
				govmap.searchInLayer({ 'layerName': 'DIVUCHIM2017', 'fieldName': 'SHNATDIVUACH', 'fieldValues': [2017], 'highlight': true, 'showBubble': true });

			}
			if (func_type == "AddressToLotParcel")
			{
				$("#myModalAddressToLotParcel").modal("show");

			}
			if (func_type == "LotParcelToAddress")
			{
				$("#myModalLotParcelToAddress").modal("show");
			}
			if (func_type == "showMeasure")
			{
				//govmap.onEvent(govmap.events.DOUBLE_CLICK).progress(function (e)
                //{
                   //alert("click event");
                //});
				govmap.showMeasure();

			}

			if (func_type == "intersectFeatures")
			{
				var israelExtentPolygonGeo = "POLYGON((129897.85 818015.41, 287854.42 818015.41, 287854.42 376689.53, 129897.85 376689.53, 129897.85 818015.41))";
				govmap.intersectFeatures({ 'geometry': israelExtentPolygonGeo, 'layerName': "KALPI_NEGISHUT", 'fields': ["OBJECTID"], getShapes: true})
				.then(function (e) {
					if (e.data != null && e.data.length > 0)
					{
						var objID = [];
						for (i = 0; i < e.data.length; i++)
						{
						  console.log(e.data[i].ObjectId);
						  objID.push(e.data[i].ObjectId);
						}
						govmap.filterLayers({ 'layerName': "KALPI_NEGISHUT", 'whereClause': "OBJECTID IN ("+objID.toString()+")", 'zoomToExtent': true });

					}
					else
					{
						console.log("0 results");
					}
				});


				//layerName: TazNationalMotRate2040_MOT
				//govmap.intersectFeatures({
                //address: "הרוקמים 26 חולון",
                //layerName: "TAZNATIONALMOTRATE2040_MOT",
               // fields: ['OBJECTID','MOTORATE40']
				//}).then(function (e)
				//{
					//result = e;
					//console.log(e.data[0].Values[0]);
				//});
			}

			if (func_type == "OnEvent")
			{
				govmap.onEvent(govmap.events.CLICK).progress(function (e)
				//govmap.draw(govmap.drawType.Point).progress(function (e)
				{
					click_result = e;
					console.log(click_result)
				});
			}
			if (func_type == "DisplayPolygons")
			{
			var bubbleContent = "<div style='border: 1px solid #525252; margin: 10px;padding: 10px;'><div style='background-color: yellow;'>{0}</div><div               style='background-color: blue;'>{1}</div></div>";
            var data = {
                wkts: ["POLYGON((151612.40 534674.88, 215112.52 538643.64, 98431.04 445774.70, 74618.49 521974.85, 80968.50 552931.17, 151612.40 533881.13,151612.40 534674.88))",
                        "POLYGON((196062.48 621458.39, 196591.65 622516.72, 197649.99 659293.88, 229929.22 665379.31, 243423.00 632306.33, 196062.48 621458.39))"],
                names: ['p1', 'p2'],
                geometryType: govmap.drawType.Polygon,
                defaultSymbol:
                    {
                    outlineColor: [0, 80, 255, 1],
                    outlineWidth: 1,
                    fillColor: [138, 43, 226, 0.5]
                    },
                symbols: [],
                clearExisting: true,
                data: {
                        tooltips: ['פוליגון 1 tooltip', 'פוליגון 2 tooltip'],
                        headers: ['פוליגון 1 כותרת','פוליגון 2 כותרת'],
                        bubbleHTML: bubbleContent,
                        bubbleHTMLParameters: [['פוליגון 1','מידע נוסף...'], ['פוליגון 2', 'מידע נוסף...']]
                }
                };
            govmap.displayGeometries(data).then(function (response)
            {
              console.log(response.data);
            });
			}
			if (func_type == "DisplayPolygons1")
			{
				var data = {
                'circleGeometries': [{ x: 179724, y: 659609, radius:1000 }],
                'names': ['p1'],
                'geometryType': govmap.geometryType.CIRCLE,
                'defaultSymbol':
                    {
                        'outlineColor': [0, 0, 255, 1],
                        'outlineWidth': 1,
                        'fillColor': [0, 255, 0, 0.5]
                    },
                'symbols': [],
                'clearExisting': true,
                'data': {}
            };
govmap.displayGeometries(data).then(function (e)
            {

            });

			}
			if (func_type == "DisplayGeometriesCircle1")
			{



				var bubbleContent = "<div style='border: 1px solid #525252; margin: 10px;padding: 10px;'><div style='background-color: yellow;'>{0}</div><div  style='background-color: blue;'>{1}</div></div>";
				var data = {
				'circleGeometries' : [{ 'x': 176085, 'y': 657600, 'radius':500 }, { 'x': 183184, 'y': 669173, 'radius':500 }],
				'names': ['p1', 'p2'],
				'geometryType': govmap.geometryType.CIRCLE,
				'defaultSymbol':
				{
					'outlineColor': [0, 0, 255, 1],
					'outlineWidth': 1,
					'fillColor': [0, 255, 0, 0.5]
				},
				'symbols': [],
				'clearExisting': false,
				'data': {
						'tooltips': ['tooltip1', 'tooltip2'],
						'headers': ['header1', 'header2'],
						'bubbles': ['', ''],
						'bubbleHTML': bubbleContent,
						'bubbleHTMLParameters': [['value1', 'value2'], ['value1', 'value2']]
					}
				}
				govmap.displayGeometries(data).then(function (e)
				{
					circle_result = e;
					console.log(e.data);
				});
				//govmap.zoomToXY({ x: 176085, y: 657600, level: 10, marker: false });
				govmap.zoomToDrawing();
			}

			if (func_type == "DisplayGeometriesCircle")
			{
				var data = {
				'circleGeometries': [{x: 189901, y: 668338, radius: 297}],
				'names': ['p1'],
				'geometryType': govmap.geometryType.CIRCLE,
				'defaultSymbol':
				{
				'outlineColor': [0, 0, 255, 1],
				'outlineWidth': 1,
				'fillColor': [0, 255, 0, 0.5]
				},
				'symbols': [],
				'clearExisting': false,
				'data': {
				'tooltips': ['tooltip1'],
				'headers': ['header1'],
				'bubbles': [''],
				'bubbleUrl': 'http://www.porterdavis.com.au/~/media/homes/astor%20grange/lot%20123%20liverpool%20street%20upc/upper-point-cook---astor-grange-54---0741_long-island-facade.jpg?as=1&h=649&la=en&w=1400&crop=1'
				 }
				};

				govmap.displayGeometries(data).then(function (e)
				{
					circle_result = e;
					console.log(e.data);
				});
				govmap.zoomToXY({ x: 189901, y: 668338, level: 10, marker: false });
				//govmap.zoomToDrawing();
			}
			if (func_type == "ReverseGeocoding")
			{
				// get map click
				govmap.onEvent(govmap.events.CLICK).progress(function (e)
				{
					click_result = e;
					// get point coordinates
					var wkt = "POINT ("+click_result.mapPoint.x+" "+click_result.mapPoint.y+")"
					console.log(wkt);
					// intersect point with parcel_ll layer
					govmap.intersectFeatures({ geometry: wkt ,layerName: "PARCEL_ALL", fields: ['GUSH_NUM', 'PARCEL']  })
					.then(function (e)
					{
						//get parcels result
						results = e;
						console.log(results);
						// save parcels objectid's
						var fieldValues = [];
						for (i = 0; i < results.data.length; i++)
						{
							fieldValues.push(results.data[i].ObjectId);
						}
						// draw point marker on map
						var data = {
							'wkts': ["POINT ("+click_result.mapPoint.x+" "+click_result.mapPoint.y+")"
							],

							'names': ['p1'],
							'geometryType': govmap.drawType.Point,
							'defaultSymbol':
							{
								'url':'https://www.govmap.gov.il/images/marker.png',
								'width':32,
								'height':32
							},

							'symbols': [{
								'url':'https://www.govmap.gov.il/images/marker.png',
								'width':32,
								'height':32
								}
							],
							'clearExisting': true,
							'data': {
							}
						};
						// highlight selected parcels
						govmap.searchInLayer({ 'layerName': "PARCEL_ALL", 'fieldName': 'OBJECTID', 'fieldValues': fieldValues, 'highlight': true, 'showBubble':false,'outLineColor':[6,55,158,128],'fillColor':[6,55,158,102] });
						alert("גוש " + results.data[0].Values[0] + " חלקה " + results.data[0].Values[1]);
						// get addresses within first parcel
						govmap.searchAndLocate({
						   type:govmap.locateType.addressToLotParcel,
						   lot:  results.data[0].Values[0],
						   parcel: results.data[0].Values[1]
					   }).then(function(e){
							var Addresses = e;
							var addresses_string = "";
							if (Addresses.data)
							{
								for (i = 0; i < Addresses.data.length; i++) {
									addresses_string = addresses_string + Addresses.data[i].Values[0]+" "+Addresses.data[i].Values[1]+" "+Addresses.data[i].Values[2] + ", ";
								}
								alert(addresses_string);
							}
						});


					});
				});
			}
			if (func_type == "GetLayerEntities")
			{
				govmap.setToken(my_user_token);
				var params = {
					layerName: '79323'
				};
				govmap.getLayerEntities(params).then(function(response){
					console.log("!");
					console.log(response);
				});
			}
			if (func_type == "GetLayerData1")
			{
				var params = {
					LayerName: 'KALPI_NEGISHUT',
					Point: {x: 217009, y: 708689},
					Radius:1000
				};
			   govmap.getLayerData(params).then(function(response){
				   console.log(response);
			   });
			}
			if (func_type == "GetLayerData")
			{
				var params = {
					LayerName: 'KALPI_NEGISHUT',
					Point: {x: 217009, y: 708689},
					Radius:5
				};
			   govmap.getLayerData(params).then(function(response){
				   console.log(response);
			   });
			}

			if (func_type == "LayerToGeojson")
			{
				LayerToGeojson("SHEET100");
			}


	   });
	});
		  var answer;
		  function TestGovMap()
		  {
				govmap.geocode({keyword: document.getElementById("string_address").value},govmap.geocodeType.FullResult)
					.then(function(response){
						console.log("then:");
						console.log(response);
						govmap.zoomToXY({ x: response.data[0].X, y: response.data[0].Y, level: 10, marker: true });
						var wkt = PointToPolygon(response.data[0].X, response.data[0].Y, 1);
						var big_wkt = PointToPolygon(response.data[0].X, response.data[0].Y, 500);
						console.log(big_wkt);
						var oids = [];
						govmap.intersectFeatures({ 'geometry': wkt, 'layerName': "PARCEL_ֹALL", 'fields': ["OBJECTID","PARCEL", "GUSH_NUM"],getShapes: true})
						.then(function (e) {
							console.log(e);
							if (e.data != null && e.data.length > 0)
							{
								var objID = [];
								for (i = 0; i < e.data.length; i++)
								{
								  console.log(e.data[i].ObjectId);
								  objID.push(e.data[i].ObjectId);
								  var new_wkt = e.data[0].Values[3];
								  console.log(new_wkt);
								  //new_wkt = new_wkt.replace("POLYGON  (( ", "POLYGON((");
								  new_wkt = new_wkt.replaceAll("0000", "");
								  console.log(new_wkt);
								  govmap.intersectFeatures({ 'geometry': new_wkt, 'layerName': "GASSTATIONS", 'fields': ["OBJECTID"],getShapes: true})
								  .then(function (e1) {
									answer = e1;
									console.log(e1);
								  });

								}
								govmap.filterLayers({ 'layerName': "SUB_GUSH_ALL", 'whereClause': "OBJECTID IN ("+objID.toString()+")", 'zoomToExtent': true });
							}
							else
							{
								console.log("0 results"); //3929
							}

						});
					})
					.done(function(response){
						console.log("done:");
						console.log(response);
					})
					.always(function(response){
						console.log("always:");
						console.log(response);
					})
					.fail(function(response){
						console.log("fail:");
						console.log(response);
					});
		  }


		  String.prototype.replaceAll = function(search, replace)
		{
			//if replace is not sent, return original string otherwise it will
			//replace search string with 'undefined'.
			if (replace === undefined) {
				return this.toString();
			}

			return this.replace(new RegExp('[' + search + ']', 'g'), replace);
		};


		  var addr_list = {};
		  var results;
		  function TestGovMapExpanded()
		  {
		  	var thep = document.getElementById("additional results");
			thep.innerHTML = "";
			//alert(document.getElementById("myModalstring").value);
			govmap.geocode({keyword: document.getElementById("myModalstring").value},govmap.geocodeType.FullResult)
					.then(function(response){
						console.log("then:");
						console.log(response);
						results = response.data;
						if (results.length == 1)
						{
							govmap.zoomToXY({ x: response.data[0].X, y: response.data[0].Y, level: 10, marker: true });
							document.getElementById("Coordinates").innerHTML = response.data[0].X + " / " + response.data[0].Y;
						}
						if (results.length > 1)
						{
							document.getElementById("Coordinates").innerHTML ="";
							var thep = document.getElementById("additional results");
							thep.appendChild(document.createElement("br"));
							thep.appendChild(document.createTextNode("האם התכוונת ל: "+ "\n"));
							thep = document.getElementById("additional results");
							thep.innerHTML = "";
							var addr_list_txt ="";
							addr_list = {};
							for (var i = 0; i < results.length; i++)
							{
								addr_list[results[i].ResultLable] = [results[i].X, results[i].Y];
								addr_list_txt = addr_list_txt + results[i].ResultLable + "\n";

								var thep = document.getElementById("additional results");
								thep.appendChild(document.createElement("br"));
								thep.appendChild(document.createTextNode("\n"));
								var r = results[i].ResultLable;
								var btn = document.createElement("BUTTON");
								btn.type  = 'button';
								btn.className="btn btn-link";
								btn.innerHTML = r;
								btn.value = r;
								btn.addEventListener('click', function() {
									document.getElementById("myModalstring").value = this.value;
									govmap.zoomToXY({ x: addr_list[this.value][0], y: addr_list[this.value][1], level: 10, marker: true });
								}, false);
								document.getElementById("additional results").appendChild(btn);
							}
						}

					})
				    .done(function(response){
						console.log("done:");
						console.log(response);
					})
					.always(function(response){
						console.log("always:");
						console.log(response);
					})
					.fail(function(response){
						console.log("fail:");
						console.log(response);
					});
		  }

		  function TestGovMapAddressToLotParcel()
		  {
				govmap.searchAndLocate({
					type:govmap.locateType.lotParcelToAddress,
					address: document.getElementById("myModalstringAddressToLotParcel").value
				}).then(function(e){
					e.data[0].Values[0];
					e.data[0].Values[1];
					document.getElementById("LotParcel").innerHTML ="גוש " + e.data[0].Values[0] + " חלקה " + e.data[0].Values[1]; //40095 13
				});

		  }

		  function TestGovMapLotParcelToAddress()
		  {
				govmap.searchAndLocate({
	               type:govmap.locateType.addressToLotParcel,
	               lot:  document.getElementById("myModalstringGush").value,
	               parcel: document.getElementById("myModalstringParcel").value
	           }).then(function(e){
				   var thep = document.getElementById("Addr");
					thep.innerHTML = "";
					var Addresses = e;
					d = e;
					thep.appendChild(document.createElement("Addresses:"));
					thep.appendChild(document.createElement("br"));
					for (i = 0; i < Addresses.data.length; i++) {

						thep.appendChild(document.createElement("br"));
						var r = Addresses.data[i].Values[0]+" "+Addresses.data[i].Values[1]+" "+Addresses.data[i].Values[2];
						var btn = document.createElement("BUTTON");
						btn.type  = 'button';
						btn.className="btn btn-link";
						btn.innerHTML = r;
						btn.value = r;
						btn.addEventListener('click', function() {
						}, false);
						thep.appendChild(btn);
					}
				});

		  }
		function PointToPolygon(x, y, r)
		{
			x1 = x - r;
			y1 = y;
			x2 = x - (((r / 2)) / (2)) - ((r / 2));
			y2 = y + (((r / 2)) / (2)) + ((r / 2));
			x3 = x;
			y3 = y + r;
			x4 = x + (((r / 2)) / (2)) + ((r / 2));
			y4 = y + (((r / 2)) / (2)) + ((r / 2));
			x5 = x + r;
			y5 = y;
			x6 = x + (((r / 2)) / (2)) + ((r / 2));
			y6 = y - (((r / 2)) / (2)) - ((r / 2));
			x7 = x;
			y7 = y - r;
			x8 = x - (((r / 2)) / (2)) - ((r / 2));
			y8 = y - (((r / 2)) / (2)) - ((r / 2));
			wkt = "POLYGON(("+x1+" "+y1+", "+x2+" "+y2+", "+x3+" "+y3+", "+x4+" "+y4+", "+x5+" "+y5+", "+x6+" "+y6+", "+x7+" "+y7+", "+x8+" "+y8+", "+x1+" "+y1+"))";
			return wkt;
		}


		var response_getlayer;
		function LayerToGeojson(LayerName)
		{
			var geom_type;
			var geo_json;
			var empty_features_list = [];
			console.log("start...");
				var fields1;
				var params = {
					LayerName: LayerName,
					// Point: {x: 217009, y: 708689},
          Point: {x: 32, y: 35},
					Radius:1
				};
			   govmap.getLayerData(params).then(function(response){
					response_getlayer = response;
					var fields = response.split("from (select ")[1].split(",ROUND")[0].split(",");
					var israelExtentPolygonGeo = "POLYGON((129897.85 818015.41, 287854.42 818015.41, 287854.42 376689.53, 129897.85 376689.53, 129897.85 818015.41))";
					govmap.intersectFeatures({ 'geometry': israelExtentPolygonGeo, 'layerName': LayerName, 'fields': fields, getShapes: true })
					.then(function (e) {
						e_obj = e;
						for (i = 0; i < e_obj.data.length; i++)
						{
							full_wkt = e_obj.data[i].Values[e_obj.data[0].Values.length - 1];
							if (full_wkt.includes("POLYGON"))
							{
								feat_wkt = full_wkt.replace("POLYGON  (( ","").replace("))", "");
								geom_type = "Polygon";
							}
							if (full_wkt.includes("LINESTRING"))
							{
								feat_wkt = full_wkt.replace("LINESTRING  (( ","").replace("))", "");
								feat_wkt = feat_wkt.replace("LINESTRING  ( ","").replace(")", "");
								feat_wkt = feat_wkt.replace("LINESTRING ZM ( ","").replace(")", "");
								geom_type = "LineString";
							}
							if (full_wkt.includes("POINT"))
							{
								feat_wkt = full_wkt.replace("POINT (( ","").replace("))", "");
								geom_type = "Point";
							}
						    var coordinates = [];
							coords = feat_wkt.split(", ");
							for (xy = 0; xy < coords.length; xy++)
							{
								if (coords[xy].split(" ").length > 0)
								{
									coordinates.push([parseFloat(coords[xy].split(" ")[0]),parseFloat(coords[xy].split(" ")[1])]);
								}
							}

							if (geom_type == "Polygon")
							{
								coordinates = [coordinates];
							}

							var index = fields.indexOf("OBJECTID");
							if (index > -1) {
							  fields.splice(index, 1);
							}
							v = e_obj.data[i].Values;
							properties = {};
							for (f = 0; f < fields.length; f++)
							{
								properties[fields[f]] = v[f];
							}

							 var feature =   {
								"type": "Feature",
								"geometry": {
									"type": geom_type,
									"coordinates":
										coordinates

								},
								"properties": properties
							}
							empty_features_list.push(feature)

						}

						geo_json = {
						  "type": "FeatureCollection",
						  "features": empty_features_list
						}
						////
						var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geo_json));
						var dlAnchorElem = document.getElementById('downloadAnchorElem');
						dlAnchorElem.setAttribute("href",     dataStr     );
						dlAnchorElem.setAttribute("download", LayerName+".geojson");
						dlAnchorElem.click();
						////
						var myJSON = JSON.stringify(geo_json);
						console.log(myJSON);
						console.log("done")
					});
			   });
		}

  </script>
</head>

<body style='width:100%; height:95%;' scrolling='no'>
<a id="downloadAnchorElem" style="display:none"></a>
		<nav class="navbar navbar-default" style="margin-bottom: 0px ">
		  <div class="container-fluid">
			<div class="navbar-header">
			  <a id="myTitle" class="navbar-brand" style="font-size:3vw;" href="#">API אתר המפות - דוגמאות לשימוש ב</a>
			</div>
			<ul id="my_li" class="nav navbar-nav navbar-right">
			  <li style="text-align: center">
			  <a id="myTitleMobile" style="font-size:6vw;" href="#">API אתר המפות - דוגמאות לשימוש ב</a>
			  </li>
			   <li style="text-align: center">
			  <button id="CancelButton" class="btn btn-danger" style="margin: 5px; display: none; text-align: center" type="button">נקה</button>
			  </li>


			 <li style="text-align: center">
			  <form class="navbar-form navbar-left" role="search">
			  <div class="form-group navbar-right">
				  <input type="text" id="string_address" dir="rtl" style='width: 100%;' class="form-control" placeholder="חיפוש: כתובת, גוש-חלקה, מקום">
				  <div style="margin: 0px auto; width: 100%; height: 1px; text-align: right;">
					<label id="Comment" style="text-align: right; font-family:arial; color:red;"></label>
				  </div>
			  </div>
			  <button id="searchButton" type="button" class="btn btn-default" OnClick= "TestGovMap();">התמקד</button>
			 </form>
			 </li>

			  <li style="text-align: center">
				  <button id="OptionsButton" class="btn btn-primary" style="margin: 9px; text-align: center" type="button" data-toggle="dropdown">שם הפונקציה
					<span class="caret"></span>
				  </button>
					<ul id="cbx_types" class="dropdown-menu" style="text-align: left;" dir="ltr">
						<li ><a href='#'>AddressToLotParcel</a></li>
						<li ><a href='#'>AddUserPoint</a></li>
						<li ><a href='#'>ClearDrawing</a></li>
						<li ><a href='#'>DrawCircle</a></li>
						<li ><a href='#'>DisplayGeometriesCircle</a></li>
						<li ><a href='#'>DrawPolygon</a></li>
						<li ><a href='#'>DisplayPolygons</a></li>
						<li ><a href='#'>DrawRectangle</a></li>
						<li ><a href='#'>FilterLayer</a></li>
						<li ><a href='#'>GeocodeString</a></li>
						<li ><a href='#'>GetLayerData</a></li>
						<li ><a href='#'>GetLayerEntities</a></li>
						<li ><a href='#'>GetXY</a></li>
						<li ><a href='#'>LayerToGeojson</a></li>
						<li ><a href='#'>LotParcelToAddress</a></li>
						<li ><a href='#'>OnEvent</a></li>
						<li ><a href='#'>intersectFeatures</a></li>
						<li ><a href='#'>ReverseGeocoding</a></li>
						<li ><a href='#'>showMeasure</a></li>
						<li ><a href='#'>searchInLayer1</a></li>
						<li ><a href='#'>searchInLayer2</a></li>
						<li ><a href='#'>ZoomToDrawing</a></li>

					</ul>
			 </li>

			</ul>
		  </div>
		</nav>



		<!-- Modal -->
		  <div class="modal fade" id="myModal" role="dialog" dir="rtl">
			<div class="modal-dialog modal-lg">
			  <div class="modal-content">
				<div class="modal-header">
				  <button type="button" class="close" data-dismiss="modal">&times;</button>
				  <h4 class="modal-title">נא להקליד טקסט לחיפוש</h4>
				</div>
				<div class="modal-body">
				<input type="text" id="myModalstring" dir="rtl" style='width: 100%;' class="form-control" placeholder="חיפוש: כתובת, גוש-חלקה, מקום">
				</div>
				<div class="modal-footer">
				  <button type="button" OnClick= "TestGovMapExpanded();" class="btn btn-default">Close</button>
				</div>
				 <div id="CoordinatesDiv" class="alert alert-danger text-center lead" dir="ltr">
				  <strong id="Coordinates"> </strong>

				</div>
				<div id="additionalDiv" class="alert alert-info">
				<p id="additional results", name="additional results", dir="rtl">
				</p>
				</div>
				</div>
			  </div>
			</div>
		  </div>


		  <!-- Modal AddressToLotParce -->
		  <div class="modal fade" id="myModalAddressToLotParcel" role="dialog" dir="rtl">
			<div class="modal-dialog modal-sm">
			  <div class="modal-content">
				<div class="modal-header">
				  <button type="button" class="close" data-dismiss="modal">&times;</button>
				  <h4 class="modal-title">נא להקליד כתובת לאיתור גוש-חלקה</h4>
				</div>
				<div class="modal-body">
				<input type="text" id="myModalstringAddressToLotParcel" dir="rtl" style='width: 100%;' class="form-control" placeholder="חיפוש: כתובת">
				</div>
				<div class="modal-footer">
				  <button type="button" OnClick= "TestGovMapAddressToLotParcel();" class="btn btn-default">Close</button>
				</div>
				 <div id="LotParcelDiv" class="alert alert-success text-center lead" dir="ltr">
				  <strong id="LotParcel"> </strong>

				</div>
				</div>
			  </div>
			</div>

		  <!-- Modal LotParcelToAddress -->
		  <div class="modal fade" id="myModalLotParcelToAddress" role="dialog" dir="rtl">
			<div class="modal-dialog modal-sm">
			  <div class="modal-content">
				<div class="modal-header">
				  <button type="button" class="close" data-dismiss="modal">&times;</button>
				  <h4 class="modal-title">נא להקליד גוש חלקה לאיתור כתובת</h4>
				</div>
				<div class="modal-body">
				<input type="text" id="myModalstringGush" dir="rtl" style='width: 100%;' class="form-control" placeholder="גוש">
				<input type="text" id="myModalstringParcel" dir="rtl" style='width: 100%;' class="form-control" placeholder="חלקה">
				</div>
				<div class="modal-footer">
				  <button type="button" OnClick= "TestGovMapLotParcelToAddress();" class="btn btn-default">Close</button>
				</div>
				 <div id="AddrDiv" class="alert alert-success text-center lead" dir="ltr">
				  <strong id="Addr"> </strong>

				</div>
				</div>
			  </div>
			</div>


	<!-- LeftSideModal -->
	<div class="modal left fade" id="myInfoModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">

				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h2 class="modal-title lead" id="myModalLabel">Location Info</h4>
				</div>

				<div id="info" class="modal-body">
				</div>

			</div>
			<!-- modal-content -->
		</div>
		<!-- modal-dialog -->
	</div>



		<form name="form" style='height: 90%;' scrolling='no'>
			<div id="map_div" style="width: 100%; height: 100%; float:left">
			</div>
	    </form>



		<footer style="position:relative;
				height: 2%;
				background: white; border-color: #0044cc #0044cc #002a80; background-repeat: repeat-x; text-align: right;">
				<p style="font-size: 110%;margin: auto; width: 100%; height: 100%;">
				<a id="mapi" href="https://www.govmap.gov.il">המרכז למיפוי ישראל 2017, אתר המפות הממשלתי</a>
				</p>
				<!--<p id="mapi" style="font-size: 120%;margin: auto; width: 100%; height: 100%; text-align: left">
				המידע המוצג במערכת בשלב זה אינו מדויק ואין להתייחס אליו בתור מידע רשמי של משרד התחבורה
				</p>-->
		</footer>
</body>
</html>
